## Add a Movie Review.

On the favourite movies page, clicking a movie's RateReview icon should allows the user write a review. We will store reviews in the moviesContext as a temporary solution but in a production app, it would be sent to the API for storage in a database. 

In `components/cardIcons/writeReview.jsx`, replace the entire content with:
~~~js
import React from "react";
import RateReviewIcon from "@mui/icons-material/RateReview";
import { Link } from "react-router-dom";

const WriteReviewIcon = ({ movie }) => {
  return (
    <Link
      to={'/reviews/form'}
      state={{
          movieId: movie.id,
        }}
    >
      <RateReviewIcon color="primary" fontSize="large" />
    </Link>
  );
};

export default WriteReviewIcon;
~~~
The icon/Link routes the app to the URL '/reviews/form' and includes the movie's Id as additional data/state. Create the file `components/reviewForm/index.jsx`, and add the following temporary code:
~~~js
import React from "react";

const ReviewForm = (props) => {
  return (
      <h3>Placeholder for web form</h3>
  );
};

export default ReviewForm;
~~~
Create the file `src/pages/addMovieReviewPage.jsx`, and add this code:
~~~js
import React from "react";
import PageTemplate from "../components/templateMoviePage";
import ReviewForm from "../components/reviewForm";
import { useLocation } from "react-router-dom";
import { useQuery } from "react-query";
import { getMovie } from "../api/tmdb-api";
import Spinner from "../components/spinner";

const WriteReviewPage = (props) => {
  const location = useLocation()
  const { movieId } = location.state;
  const { data: movie, error, isLoading, isError } = useQuery(
    ["movie", { id: movieId }],
    getMovie
  );

  if (isLoading) {
    return <Spinner />;
  }

  if (isError) {
    return <h1>{error.message}</h1>;
  }
  return (
    <PageTemplate movie={movie}>
      <ReviewForm movie={movie} />
    </PageTemplate>
  );
};

export default WriteReviewPage;
~~~
Update the routing configuration in `src/index.jsx`, as follows:

+ add an import at the top:
~~~js
import AddMovieReviewPage from './pages/addMovieReviewPage'
~~~

+ add a new route to the list:
~~~js
    <Routes>
        <Route path="/reviews/form" element={<AddMovieReviewPage/>} />
        . . . . other routes . . . . 
    </Routes>
~~~
In the browser, go to the favourite movies page and click the RateReview icon of a movie. It should display our new page:

![][reviewform]

### Web forms in React.

Web forms tend to have a standard feature set, e.g. field validation and error messages, submit action, reset fields, etc. We will use a 3rd party module to simplify implementing these requirements - the react-hook-form library ([read more][useform]). [See react-hook-form in `package.json`.] 

In `components/reviewForm`:
- Create the file `ratingCategories.js:
~~~js
const ratings = [
  {
    value: 5,
    label: "Excellent",
  },
  {
    value: 4,
    label: "Good",
  },
  {
    value: 3,
    label: "Average",
  },
  {
    value: 2,
    label: "Poor",
  },
  {
    value: 0,
    label: "Terrible",
  },
];
  export default ratings
~~~
- Create the file `styles.js`:
~~~js
const styles =  {
  root: {
    marginTop: 2,
    display: "flex",
    flexDirection: "column",
    alignItems: "left",
  },
  form: {
    width: "100%",
    "& > * ": {
      marginTop: 2,
    },
  },
  textField: {
    width: "40ch",
  },
  submit: {
    marginRight: 2,
  },
  snack: {
    width: "50%",
    "& > * ": {
      width: "100%",
    },
  },
};
export default styles
~~~
- Replace the content of `index.jsx` with the following:,
~~~js
import React, { useContext, useState } from "react";
import Button from "@mui/material/Button";
import TextField from "@mui/material/TextField";
import MenuItem from "@mui/material/MenuItem";
import Typography from "@mui/material/Typography";
import Box from "@mui/material/Box";
import { useForm, Controller } from "react-hook-form";
import { MoviesContext } from "../../contexts/moviesContext";
import { useNavigate } from "react-router-dom";
import styles from "./styles";
import ratings from "./ratingCategories";

const ReviewForm = ({ movie }) => {
  const defaultValues = {
    author: "",
    review: "",
    agree: false,
    rating: "3",
  };
  const {
    control,
    formState: { errors },
    handleSubmit,
    reset,
  } = useForm(defaultValues);
  const navigate = useNavigate();
  const context = useContext(MoviesContext);
  const [rating, setRating] = useState(3);


  const handleRatingChange = (event) => {
    setRating(event.target.value);
  };

  const onSubmit = (review) => {
    review.movieId = movie.id;
    review.rating = rating;
    // console.log(review);
  };

  return (
    <Box component="div" sx={styles.root}>
      <Typography component="h2" variant="h3">
        Write a review
      </Typography>
      <form sx={styles.form} onSubmit={handleSubmit(onSubmit)} noValidate>
        <Controller
          name="author"
          control={control}
          rules={{ required: "Name is required" }}
          defaultValue=""
          render={({ field: { onChange, value } }) => (
            <TextField
              sx={{ width: "40ch" }}
              variant="outlined"
              margin="normal"
              required
              onChange={onChange}
              value={value}
              id="author"
              label="Author's name"
              autoFocus
            />
          )}
        />
        {errors.author && (
          <Typography variant="h6" component="p">
            {errors.author.message}
          </Typography>
        )}
        <Controller
          name="review"
          control={control}
          rules={{
            required: "Review cannot be empty.",
            minLength: { value: 10, message: "Review is too short" },
          }}
          defaultValue=""
          render={({ field: { onChange, value } }) => (
            <TextField
              variant="outlined"
              margin="normal"
              required
              fullWidth
              value={value}
              onChange={onChange}
              label="Review text"
              id="review"
              multiline
              minRows={10}
            />
          )}
        />
        {errors.review && (
          <Typography variant="h6" component="p">
            {errors.review.message}
          </Typography>
        )}

        <Controller
          control={control}
          name="rating"
          render={({ field: { onChange, value } }) => (
            <TextField
              id="select-rating"
              select
              variant="outlined"
              label="Rating Select"
              value={rating}
              onChange={handleRatingChange}
              helperText="Don't forget your rating"
            >
              {ratings.map((option) => (
                <MenuItem key={option.value} value={option.value}>
                  {option.label}
                </MenuItem>
              ))}
            </TextField>
          )}
        />

        <Box sx={styles.buttons}>
          <Button
            type="submit"
            variant="contained"
            color="primary"
            sx={styles.submit}
          >
            Submit
          </Button>
          <Button
            type="reset"
            variant="contained"
            color="secondary"
            sx={styles.submit}
            onClick={() => {
              reset({
                author: "",
                content: "",
              });
            }}
          >
            Reset
          </Button>
        </Box>
      </form>
    </Box>
  );
};

export default ReviewForm;
~~~
The useForm hook in the above code is the cornerstone. The properties of the object it returns connect the hook's form processing logic to our web form. The properties include:

+ handleSubmit - a function to connect our custom form submit event handler to react-hook-form.
+ reset - a function to reset the form fields.
+ errors - an object populated with field validation error messages computed from the validation rules declared in the Controller components.
+ control - a function for controlling a field on the web fork.

The react-hook-form library also provides the Controller component for managing a form field. It declares the field's validation criteria (rules), name, and how it should render (render). For example, the code for the review content field is as follows:
~~~js
     <Controller
          name="review"
          control={control}
          rules={{
            required: "Review cannot be empty.",
            minLength: { value: 10, message: "Review is too short" },
          }}
          defaultValue=""
          render={({ field: { onChange, value } }) => (
            <TextField
              variant="outlined"
              margin="normal"
              required
              fullWidth
              value={value}
              onChange={onChange}
              label="Review text"
              id="review"
              multiline
              minRows={10}
            />
          )}
        />
~~~
The render prop above is an example of the Render prop pattern. The callback assigned to it is invoked by the Controller, passing it the current value of the field and a default onChange event handler. The validation rules object above uses prescribed keys (e.g. required, minlength, min, max). The hook enforces these rules, and it records any violations in an errors object, which we use to control the display of error messages, for example:
~~~js
        {errors.review && (
          <Typography variant="h6" component="p">
            {errors.review.message}
          </Typography>
        )}
~~~ 
The error messages appear under the offending field, as shown below:

![][errorform]

### Storing the reviews.
As an interim solution, we will store reviews in the MoviesContext.

In `contexts/moviesContext.jsx`, make the changes shown below:
~~~js
..... other code as before .....

const MoviesContextProvider = (props) => {
  const [myReviews, setMyReviews] = useState( {} )  // NEW

  ..... other code as before  .....

  const addReview = (movie, review) => {   // NEW
    setMyReviews( {...myReviews, [movie.id]: review } )
  };

 return (
    <MoviesContext.Provider
      value={{
        favourites,
        addToFavourites,
        removeFromFavourites,
        addReview,    // NEW
      }}
    >
      {props.children}
    </MoviesContext.Provider>
  );
};

export default MoviesContextProvider;
~~~
In `components/reviewForm/index.jsx`, update the onSubmit function:
~~~js
  const onSubmit = (review) => {
    review.movieId = movie.id;
    review.rating = rating;
    context.addReview(movie, review);
  };
~~~
In the browser, try adding a review for a favourite movie. 

It work, but a better user experience would be to acknowledge the review submission. We will use the Material Snackbar component to serve this purpose.

![][snackbar]

In `components/reviewForm/index.jsx`:
- Add two new imports:
~~~js
import Snackbar from "@mui/material/Snackbar";
import Alert from "@mui/material/Alert";
~~~
- Add another state variable declaration (after rating):
~~~js
  const [open, setOpen] = React.useState(false);  //NEW
~~~
- Add an event handler (before onSubmit):
~~~js
  const handleSnackClose = (event) => {
    setOpen(false);
    navigate("/movies/favourites");
  };
~~~
- change the onSubmit event handler:
~~~js
  const onSubmit = (review) => {
    review.movieId = movie.id;
    review.rating = rating;
    // console.log(review);
    context.addReview(movie, review);
    setOpen(true); // NEW
  };
~~~
- Add the Snackbar component, just before the Form component:
~~~js
      <Snackbar
        sx={styles.snack}
        anchorOrigin={{ vertical: "top", horizontal: "right" }}
        open={open}
        onClose={handleSnackClose}
      >
        <Alert
          severity="success"
          variant="filled"
          onClose={handleSnackClose}
        >
          <Typography variant="h4">
            Thank you for submitting a review
          </Typography>
        </Alert>
      </Snackbar>
~~~
Now when the user clicks the submit button, the snackbar acknowledgement displays. Clicking its close icon will redirect the browser back to the favourites page. 

Update the git repository as follows:
~~~
$ git add -A
$ git commit -m "Add new review support."
$ git push origin master
~~~

[reviewform]: ./img/reviewForm.png
[useform]: https://react-hook-form.com/
[errorform]: ./img/errorform.png
[snackbar]: ./img/snackbar.png
